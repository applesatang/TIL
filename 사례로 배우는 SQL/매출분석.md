# 매출분석

### 일/주/월/분기별 매출액 및 주문건수
일별 매출액 및 주문건수 추출 (postgresSQL)

```
SELECT DATE_TRUNC('day',order_date)::date as day, SUM(amount) as day_amount, COUNT(DISTINCT a.order_id) as daily_ord_cnt
FROM nw.orders a
     JOIN nw.order_items b ON a.order_id = b.order_id 
GROUP BY DATE_TRUNC('day',order_date)::date
ORDER BY 1
;
```
- order_date 의 타입이 timestamp 인 경우, 날짜 추출을 위해 DATE_TRUNC 사용
- DATE_TRUNC('day/week/month/quarter',해당 컬럼)
- week = 주의 첫째날, month = 월의 첫째날, quarter = 분기별 첫째날
- ::date -> DATE_TRUNC의 경우 timestamp 타입으로 나오기 때문에 date타입으로 변환 (postgresSQL)
- COUNT(DISTINCT a.order_id) : order_items 컬럼에서 상품별로 분리가 되어있기 때문에 order_id의 중복 발생
  

### 일별 매출 시각화

```
# Postgresql 연동 라이브러리 로딩 및 DB 접속
import pandas as pd
from sqlalchemy import create_engine
conn_string = 'postgresql://postgres:1234@localhost:5432/postgres'
postgres_engine = create_engine(conn_string)

#데이터 추출
query = """
SELECT DATE_TRUNC('day',order_date)::date as day, SUM(amount) as sum_amount, COUNT(DISTINCT a.order_id) as daily_ord_cnt
FROM nw.orders a
     JOIN nw.order_items b ON a.order_id = b.order_id 
GROUP BY DATE_TRUNC('day',order_date)::date
ORDER BY 1
"""

#데이터 프레임화
df = pd.read_sql_query(sql=query, con=postgres_engine)

#일별 라인차트 시각화
import plotly.express as px
fig = px.line(data_frame=df, x='day', y='sum_amount')
fig.show()
```
![일별라인차트](https://github.com/applesatang/TIL/blob/main/%EC%82%AC%EB%A1%80%EB%A1%9C%20%EB%B0%B0%EC%9A%B0%EB%8A%94%20SQL/img/001.png)

### 월별 매출 시각화
```
# Postgresql 연동 라이브러리 로딩 및 DB 접속 생략
#데이터 추출
query = """
SELECT DATE_TRUNC('month',order_date)::date as month, SUM(amount) as sum_amount, COUNT(DISTINCT a.order_id) as ord_cnt
FROM nw.orders a
     JOIN nw.order_items b ON a.order_id = b.order_id 
GROUP BY DATE_TRUNC('month',order_date)::date
ORDER BY 1
"""
df = pd.read_sql_query(sql=query, con=postgres_engine)

# 라인차트 시각화
fig = px.line(data_frame=df, x='month', y='sum_amount')
fig.update_xaxes(type ='category')
fig.show()
```